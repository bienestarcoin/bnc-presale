<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bienestar Coin (BNC) – Preventa Oficial</title>
  <meta name="description" content="Preventa oficial de Bienestar Coin (BNC) en BNB Smart Chain. 1 USDT = 20 BNC." />

  <!-- Ethers.js v5 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <!-- Intento inicial de WalletConnect (si carga, perfecto) -->
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider@2.11.2/dist/index.umd.min.js"></script>

  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="preconnect" href="https://unpkg.com" crossorigin>

  <style>
    :root{ --gold:#d4af37; --gold-2:#f4d35e; --black:#0b0b0b; --card:#151515;
      --text:#eaeaea; --muted:#bdbdbd; --ok:#6ee7b7; --warn:#f59e0b; --err:#f87171; }
    *{box-sizing:border-box}
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial;
      background: radial-gradient(1200px 500px at 50% -10%, rgba(212,175,55,.15), transparent 70%), var(--black);
      color:var(--text); min-height:100vh; display:flex; flex-direction:column; align-items:center; }
    header{width:100%; max-width:980px; padding:24px 16px 8px; display:flex; align-items:center; gap:14px;}
    header img.logo{ width:56px; height:56px; border-radius:50%; object-fit:cover;
      box-shadow:0 0 0 2px rgba(212,175,55,.35), 0 10px 24px rgba(0,0,0,.4);}
    h1{font-size:clamp(22px,3.5vw,30px); margin:0}
    .sub{ color:var(--muted); margin-top:4px; font-size:14px }
    .card{
      width:100%; max-width:980px; margin:18px 16px; padding:18px;
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00)), var(--card);
      border:1px solid rgba(212,175,55,.25); border-radius:14px;
      box-shadow:0 6px 30px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.02);
    }
    .grid{ display:grid; gap:16px; grid-template-columns: 1fr 1fr; }
    @media (max-width:820px){ .grid{ grid-template-columns:1fr; } }
    .row{display:flex; gap:10px; align-items:center; justify-content:space-between}
    .row label{font-size:13px; color:var(--muted)}
    input[type="number"], input[type="text"]{
      width:100%; background:#0f0f0f; color:var(--text); border:1px solid rgba(212,175,55,.25);
      border-radius:10px; padding:12px 14px; font-size:16px; outline:none;
    }
    input[readonly]{opacity:.85}
    .btn{
      width:100%; padding:12px 16px; font-weight:600; font-size:15px; border:none; border-radius:10px; cursor:pointer;
      background: linear-gradient(90deg, var(--gold), var(--gold-2)); color:#151515; box-shadow:0 8px 24px rgba(212,175,55,.25);
      transition: transform .05s ease, filter .15s ease;
    }
    .btn:hover{ filter:brightness(1.03) } .btn:active{ transform:translateY(1px) }
    .btn.alt{ background:#1d1d1d; color:var(--text); border:1px solid rgba(212,175,55,.25); box-shadow:none; }
    .pill{ display:inline-flex; align-items:center; gap:8px; font-size:13px; padding:8px 12px; border-radius:999px;
      border:1px solid rgba(212,175,55,.25); background:#101010; color:var(--muted); }
    .status{margin-top:12px; font-size:14px} .status.ok{color:var(--ok)} .status.warn{color:var(--warn)} .status.err{color:var(--err)}
    .mini{ font-size:13px; color:var(--muted); display:grid; grid-template-columns:auto 1fr; gap:6px 12px; }
    .oktag{ display:inline-block; padding:3px 8px; border-radius:999px; background:#0f1a14; border:1px solid rgba(110,231,183,.35); color:var(--ok); font-size:12px; }
    .notag{ display:inline-block; padding:3px 8px; border-radius:999px; background:#1a1410; border:1px solid rgba(245,158,11,.35); color:var(--warn); font-size:12px; }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; }
    .debug{ font-size:11px; color:#aaa; margin-top:8px; white-space:pre-wrap;}
    .fallback{ display:none; gap:8px; flex-wrap:wrap; }
    .fallback .btn{ width:auto; padding:10px 12px; font-size:14px; }
  </style>
</head>
<body>

  <header>
    <img class="logo" src="./logo.png" alt="BNC" />
    <div>
      <h1>Bienestar Coin (BNC) – Preventa Oficial</h1>
      <div class="sub">1 USDT = <b>20 BNC</b> · Mín: 5 USDT · Máx: 50,000 USDT · Red: <b>BSC</b></div>
    </div>
  </header>

  <section class="card">
    <div class="grid">
      <div style="display:flex; flex-direction:column; gap:12px">
        <div class="row">
          <button id="btnConnect" class="btn">Conectar Wallet</button>
          <button id="btnSwitch"  class="btn alt">Cambiar a BSC</button>
        </div>

        <div class="row">
          <span class="pill">Wallet: <b id="walletShort">–</b></span>
          <span class="pill">Red: <b id="chainName">–</b></span>
        </div>

        <label>Monto USDT</label>
        <input id="usdtInput" type="number" min="0" step="0.01" placeholder="Ej. 5" />

        <label>Recibirás BNC</label>
        <input id="bncOutput" type="text" readonly placeholder="0" />
      </div>

      <div style="display:flex; flex-direction:column; gap:12px">
        <button id="btnApprove" class="btn">1) Aprobar USDT</button>
        <button id="btnBuy" class="btn" disabled>2) Comprar BNC</button>

        <div id="status" class="status">Estado: –</div>
        <div id="debug" class="debug"></div>

        <div class="card" style="margin:0; padding:12px">
          <div style="font-size:13px; color:var(--muted); line-height:1.5">
            <div>Contrato <b>BNC</b>: <code class="addr" id="addrBNC"></code></div>
            <div><b>USDT</b>: <code class="addr" id="addrUSDT"></code></div>
            <div><b>Preventa</b>: <code class="addr" id="addrPresale"></code></div>
          </div>
        </div>

        <div class="card" style="margin:0; padding:12px">
          <div class="mini">
            <span><b>Balance USDT:</b></span> <span id="miniBalance">—</span>
            <span><b>Allowance (a Preventa):</b></span> <span id="miniAllowance">—</span>
            <span><b>Requerido para comprar:</b></span> <span id="miniRequired">—</span>
            <span><b>Estado aprobación:</b></span> <span id="miniApproveState"><span class="notag">Falta aprobar</span></span>
          </div>
        </div>

        <!-- Fallback visible si WC UMD no carga -->
        <div id="fallbackRow" class="fallback">
          <button class="btn alt" id="btnOpenMetaMask">Abrir en MetaMask App</button>
          <button class="btn alt" id="btnOpenTrust">Abrir en Trust Wallet</button>
          <button class="btn alt" id="btnOpenBinance">Abrir en Binance Web3 Wallet</button>
        </div>

      </div>
    </div>
  </section>

  <footer>© Bienestar Coin · Esta dApp es de preventa. Revisa siempre la dirección de contrato.</footer>

<script>
/* ========= CONFIG ========= */
var ADDR_BNC     = "0xDa7A76879F12824C5E96985F794CDE4F90869D2E";
var ADDR_USDT    = "0x55d398326f99059fF775485246999027B3197955";
var ADDR_PRESALE = "0xCcAc983D6e111f6f21384E40FA1e305C70844fC4";
var CHAIN_ID     = 56;
var WC_PROJECT_ID= "b4feca4564a2101fb8925873d5186274";

var ERC20_ABI = [
  "function decimals() view returns (uint8)",
  "function balanceOf(address) view returns (uint256)",
  "function allowance(address owner, address spender) view returns (uint256)",
  "function approve(address spender, uint256 amount) returns (bool)"
];
var PRESALE_ABI = [
  "function buyWithUSDT(uint256 usdtAmount) external",
  "function minUSDT() view returns (uint256)",
  "function maxUSDT() view returns (uint256)",
  "function hardCapUSDT() view returns (uint256)",
  "function rate() view returns (uint256)"
];

/* ========= Estado ========= */
var provider, signer, account = null;
var wcProvider = null;
var USDT_DEC = 18, BNC_DEC = 18;
var RATE_SCALED = ethers.utils.parseUnits("20", 18);
var USDT_BAL = ethers.constants.Zero;
var USDT_ALLOW = ethers.constants.Zero;

/* ========= Helpers UI ========= */
function $(id){ return document.getElementById(id); }
$("addrBNC").textContent     = ADDR_BNC;
$("addrUSDT").textContent    = ADDR_USDT;
$("addrPresale").textContent = ADDR_PRESALE;

function setStatus(msg, type){ $("status").textContent="Estado: "+msg; $("status").className="status "+(type||""); }
function debugLog(m){ var el=$("debug"); if(el){ el.textContent+=(el.textContent?"\n":"")+m; } try{console.log(m);}catch(_){} }
function shortAddr(a){ return a ? a.slice(0,6)+"…"+a.slice(-4) : "–"; }
function chainName(id){ id=Number(id); return id===56?"BSC":(id===97?"BSC Testnet":"Chain "+id); }
function fmtLocaleFromUnits(bn, dec){ try{ var s=ethers.utils.formatUnits(bn, dec); var n=Number(s); return isNaN(n)?s:n.toLocaleString("es-MX",{maximumFractionDigits:6}); }catch(_){ return "—"; } }

/* ========= Deep links (fallback sin WC) ========= */
function currentCleanUrl(){
  // Usa el dominio público donde sirves la dApp (IMPORTANTE si usas un subdominio)
  // Por defecto usamos la URL actual:
  return location.origin + location.pathname + location.search;
}
function openInMetaMask(){ location.href = "https://metamask.app.link/dapp/" + encodeURIComponent(currentCleanUrl()); }
function openInTrust(){ location.href    = "https://link.trustwallet.com/open_url?coin_id=20000714&url=" + encodeURIComponent(currentCleanUrl()); }
function openInBinance(){ location.href  = "bnc://app?action=wallet_web3&url=" + encodeURIComponent(currentCleanUrl()); } // algunos dispositivos soportan este esquema

$("btnOpenMetaMask").addEventListener("click", openInMetaMask);
$("btnOpenTrust").addEventListener("click", openInTrust);
$("btnOpenBinance").addEventListener("click", openInBinance);

/* ========= Detectar proveedor inyectado ========= */
function getInjectedProvider(){
  if (!window.ethereum) return null;
  if (window.ethereum.providers && window.ethereum.providers.length){
    for (var i=0;i<window.ethereum.providers.length;i++){
      var p = window.ethereum.providers[i];
      if (p && p.isMetaMask) return p;
    }
    return window.ethereum.providers[0];
  }
  return window.ethereum;
}

/* ========= Cargador robusto WalletConnect ========= */
function getWCEthereumProviderInit(){
  if (window.WalletConnectProvider && window.WalletConnectProvider.EthereumProvider && window.WalletConnectProvider.EthereumProvider.init) return window.WalletConnectProvider.EthereumProvider.init;
  if (window.WalletConnectProvider && window.WalletConnectProvider["default"] && window.WalletConnectProvider["default"].init) return window.WalletConnectProvider["default"].init;
  if (window.WalletConnectEthereumProvider && window.WalletConnectEthereumProvider.init) return window.WalletConnectEthereumProvider.init;
  if (window.EthereumProvider && window.EthereumProvider.init) return window.EthereumProvider.init;
  return null;
}
function loadScript(src, ok, err){
  var s=document.createElement("script");
  s.src=src; s.async=true; s.defer=true; s.crossOrigin="anonymous";
  s.onload=function(){ ok&&ok(); };
  s.onerror=function(){ err&&err(new Error("error: "+src)); };
  document.head.appendChild(s);
}
function ensureWCUmd(cb){
  if (getWCEthereumProviderInit()) return cb(true);
  var cdn1="https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider@2.11.2/dist/index.umd.min.js";
  var cdn2="https://unpkg.com/@walletconnect/ethereum-provider@2.11.2/dist/index.umd.min.js";
  loadScript(cdn1, function(){
    if (getWCEthereumProviderInit()) return cb(true);
    loadScript(cdn2, function(){ cb(!!getWCEthereumProviderInit()); }, function(){ cb(false); });
  }, function(){
    loadScript(cdn2, function(){ cb(!!getWCEthereumProviderInit()); }, function(){ cb(false); });
  });
}

/* ========= initWC con fallback a deep links ========= */
function initWC(cb){
  if (wcProvider) return cb(null, wcProvider);
  ensureWCUmd(function(ok){
    if (!ok){
      setStatus("No se pudo cargar WalletConnect. Usa los botones de abajo.", "warn");
      $("fallbackRow").style.display = "flex";
      return cb(new Error("WC UMD bloqueado"), null);
    }
    var wcInit = getWCEthereumProviderInit();
    wcInit({
      projectId: WC_PROJECT_ID,
      chains: [CHAIN_ID],
      rpcMap: { 56: "https://bsc-dataseed.binance.org/" },
      showQrModal: true,
      methods: [
        "eth_sendTransaction","personal_sign","eth_signTypedData",
        "eth_requestAccounts","wallet_switchEthereumChain","wallet_addEthereumChain"
      ],
      events: ["chainChanged","accountsChanged","disconnect"]
    }).then(function(wc){
      wcProvider = wc;
      cb(null, wcProvider);
    }).catch(function(err){
      setStatus("WC no inicializó. Usa los botones de abajo.", "warn");
      $("fallbackRow").style.display = "flex";
      cb(err, null);
    });
  });
}

/* ========= Conectar (inyectado → WC → deep link) ========= */
function connectWalletUniversal(){
  setStatus("Conectando…","warn");
  var injected = getInjectedProvider();
  if (injected){
    provider = new ethers.providers.Web3Provider(injected, "any");
    provider.send("eth_requestAccounts", []).then(afterConnected).catch(function(e){
      setStatus("No se pudo conectar: " + (e && (e.message||e)), "err");
    });
    return;
  }
  initWC(function(err, wc){
    if (!err && wc){
      wc.enable().then(function(){
        provider = new ethers.providers.Web3Provider(wc, "any");
        afterConnected();
      }).catch(function(e){
        setStatus("WalletConnect cancelado. Puedes usar los botones de abajo.", "warn");
        $("fallbackRow").style.display = "flex";
      });
    } else {
      // ULTIMO RECURSO: mostrar deep links
      $("fallbackRow").style.display = "flex";
      setStatus("Abre la dApp en tu wallet con los botones de abajo.", "warn");
    }
  });
}

function afterConnected(){
  signer = provider.getSigner();
  signer.getAddress().then(function(addr){
    account = addr;
    $("walletShort").textContent = shortAddr(account);
    return provider.getNetwork();
  }).then(function(net){
    if (Number(net.chainId)!==56){
      return provider.provider.request({ method:"wallet_switchEthereumChain", params:[{ chainId:"0x38" }] })
      .catch(function(e){
        if (e && e.code===4902){
          return provider.provider.request({
            method:"wallet_addEthereumChain",
            params:[{ chainId:"0x38", chainName:"BNB Smart Chain",
              nativeCurrency:{ name:"BNB", symbol:"BNB", decimals:18 },
              rpcUrls:["https://bsc-dataseed.binance.org/"], blockExplorerUrls:["https://bscscan.com/"] }]
          });
        } else { throw e; }
      }).then(function(){ return provider.getNetwork(); });
    }
    return net;
  }).then(function(net2){
    $("chainName").textContent = chainName(net2.chainId);
    setStatus("Wallet conectada.","ok");

    // Listeners
    if (provider && provider.provider && provider.provider.on){
      provider.provider.on("accountsChanged", function(a){ if(a && a[0]){ account=a[0]; $("walletShort").textContent=shortAddr(account); refreshBalances(); } });
      provider.provider.on("chainChanged",  function(cid){ $("chainName").textContent=chainName(Number(cid)); refreshBalances(); });
      provider.provider.on("disconnect",    function(){ provider=signer=account=null; $("walletShort").textContent="–"; $("chainName").textContent="–"; setStatus("Desconectado."); resetMini(); });
    }

    // Cargar parámetros y balances
    loadOnchainParams().then(function(){ onUsdtInput(); refreshBalances(); });
  }).catch(function(e){
    setStatus("Error tras conectar: " + (e && (e.message||e)), "err");
  });
}

/* ========= Cambiar a BSC ========= */
function switchToBSC(){
  if (!provider) return setStatus("Conecta tu wallet primero.", "warn");
  provider.provider.request({ method:"wallet_switchEthereumChain", params:[{ chainId:"0x38" }] })
  .then(function(){ $("chainName").textContent="BSC"; setStatus("Red cambiada a BSC.","ok"); refreshBalances(); })
  .catch(function(err){
    if (err && err.code===4902){
      provider.provider.request({
        method:"wallet_addEthereumChain",
        params:[{ chainId:"0x38", chainName:"BNB Smart Chain",
          nativeCurrency:{ name:"BNB", symbol:"BNB", decimals:18 },
          rpcUrls:["https://bsc-dataseed.binance.org/"], blockExplorerUrls:["https://bscscan.com/"] }]
      }).then(function(){ setStatus("BSC agregada. Intenta de nuevo.","ok"); })
      .catch(function(){ setStatus("No se pudo agregar BSC.","err"); });
    } else setStatus("No se pudo cambiar a BSC: " + (err && (err.message||err)), "err");
  });
}

/* ========= On-chain params ========= */
function loadOnchainParams(){
  return new Promise(function(resolve){
    try{
      var rpc = provider ? provider : new ethers.providers.JsonRpcProvider("https://bsc-dataseed.binance.org/");
      var usdt = new ethers.Contract(ADDR_USDT, ERC20_ABI, rpc);
      var bnc  = new ethers.Contract(ADDR_BNC,  ERC20_ABI, rpc);
      var sale = new ethers.Contract(ADDR_PRESALE, PRESALE_ABI, rpc);

      usdt.decimals().then(function(n){ USDT_DEC = Number(n); }).catch(function(){ USDT_DEC = 18; });
      bnc.decimals().then(function(n){ BNC_DEC = Number(n); }).catch(function(){ BNC_DEC = 18; });
      sale.rate().then(function(r){ if (r && r.gt && r.gt(0)) RATE_SCALED = r.mul(ethers.constants.WeiPerEther); }).catch(function(){});

      setTimeout(resolve, 250);
    }catch(_){ resolve(); }
  });
}

/* ========= Cálculo USDT->BNC ========= */
function onUsdtInput(){
  var v = $("usdtInput").value.trim();
  if (!v || Number(v) <= 0){ $("bncOutput").value="0"; updateApprovalUI(null); return; }

  var rateScaled = (RATE_SCALED && RATE_SCALED.gt && RATE_SCALED.gt(0)) ? RATE_SCALED : ethers.utils.parseUnits("20", 18);

  var usdtWei;
  try{ usdtWei = ethers.utils.parseUnits(v.replace(',', '.'), USDT_DEC); }
  catch(_){ $("bncOutput").value="0"; updateApprovalUI(null); return; }

  var tokensWei;
  if (BNC_DEC >= USDT_DEC) {
    var s1 = ethers.BigNumber.from(10).pow(BNC_DEC - USDT_DEC);
    tokensWei = usdtWei.mul(rateScaled).mul(s1).div(ethers.constants.WeiPerEther);
  } else {
    var s2 = ethers.BigNumber.from(10).pow(USDT_DEC - BNC_DEC);
    tokensWei = usdtWei.mul(rateScaled).div(s2).div(ethers.constants.WeiPerEther);
  }

  var pretty = Number(ethers.utils.formatUnits(tokensWei, BNC_DEC));
  $("bncOutput").value = isFinite(pretty) ? pretty.toLocaleString("es-MX",{maximumFractionDigits:6}) : "0";

  updateApprovalUI(usdtWei);
}

/* ========= Balances / allowance ========= */
function refreshBalances(){
  return new Promise(function(resolve){
    if (!provider || !account){ resetMini(); return resolve(); }
    var usdt = new ethers.Contract(ADDR_USDT, ERC20_ABI, provider);
    usdt.balanceOf(account).then(function(bn){ USDT_BAL=bn; $("miniBalance").textContent=fmtLocaleFromUnits(USDT_BAL,USDT_DEC)+" USDT"; });
    usdt.allowance(account, ADDR_PRESALE).then(function(bn){ USDT_ALLOW=bn; $("miniAllowance").textContent=fmtLocaleFromUnits(USDT_ALLOW,USDT_DEC)+" USDT"; });
    setTimeout(function(){
      var v=$("usdtInput").value.trim();
      var req = v && Number(v)>0 ? ethers.utils.parseUnits(v.replace(',', '.'), USDT_DEC) : null;
      updateApprovalUI(req);
      resolve();
    },250);
  });
}
function resetMini(){
  $("miniBalance").textContent="—";
  $("miniAllowance").textContent="—";
  $("miniRequired").textContent="—";
  $("miniApproveState").innerHTML='<span class="notag">Falta aprobar</span>';
  $("btnBuy").disabled=true;
}
function updateApprovalUI(requiredWei){
  try{
    if (!requiredWei || (requiredWei.lte && requiredWei.lte(0))){
      $("miniRequired").textContent="—";
      $("miniApproveState").innerHTML='<span class="notag">Falta aprobar</span>';
      $("btnBuy").disabled=true; return;
    }
    $("miniRequired").textContent=fmtLocaleFromUnits(requiredWei,USDT_DEC)+" USDT";
    var okBal = USDT_BAL.gte ? USDT_BAL.gte(requiredWei):false;
    var okAll = USDT_ALLOW.gte ? USDT_ALLOW.gte(requiredWei):false;
    if (okAll){ $("miniApproveState").innerHTML='<span class="oktag">Aprobación lista ✓</span>'; $("btnBuy").disabled=!okBal; }
    else { $("miniApproveState").innerHTML='<span class="notag">Falta aprobar</span>'; $("btnBuy").disabled=true; }
  }catch(_){ $("btnBuy").disabled=true; }
}

/* ========= Aprobar / Comprar ========= */
function approveUSDT(){
  if (!provider || !signer) return setStatus("Conecta tu wallet primero.","warn");
  var amountStr=$("usdtInput").value.trim();
  if (!amountStr || Number(amountStr)<=0) return setStatus("Ingresa un monto válido.","warn");

  var saleRead=new ethers.Contract(ADDR_PRESALE,PRESALE_ABI,provider);
  var usdt=new ethers.Contract(ADDR_USDT,ERC20_ABI,signer);

  Promise.all([saleRead.minUSDT(), saleRead.maxUSDT()]).then(function(vals){
    var minUSDT=vals[0], maxUSDT=vals[1];
    var amt=ethers.utils.parseUnits(amountStr.replace(',', '.'),USDT_DEC);
    if (amt.lt(minUSDT)) return setStatus("Monto menor al mínimo permitido.","warn");
    if (amt.gt(maxUSDT)) return setStatus("Monto mayor al máximo permitido.","warn");

    setStatus("Aprobando USDT… firma en tu wallet.","warn");
    $("btnApprove").disabled=true;
    return usdt.approve(ADDR_PRESALE,amt).then(function(tx){ return tx.wait(); })
      .then(function(){
        setStatus("USDT aprobado correctamente.","ok");
        return usdt.allowance(account,ADDR_PRESALE);
      }).then(function(alw){
        USDT_ALLOW=alw;
        $("miniAllowance").textContent=fmtLocaleFromUnits(USDT_ALLOW,USDT_DEC)+" USDT";
        updateApprovalUI(amt);
      }).catch(function(err){
        setStatus((err && (err.data && err.data.message || err.message)) || "Fallo al aprobar USDT.","err");
      }).finally(function(){ $("btnApprove").disabled=false; });
  }).catch(function(){ setStatus("No se pudo leer límites de preventa.","err"); });
}

function buyBNC(){
  if (!provider || !signer) return setStatus("Conecta tu wallet primero.","warn");
  var amountStr=$("usdtInput").value.trim();
  if (!amountStr || Number(amountStr)<=0) return setStatus("Ingresa un monto válido.","warn");

  var saleRead=new ethers.Contract(ADDR_PRESALE,PRESALE_ABI,provider);
  var presale=new ethers.Contract(ADDR_PRESALE,PRESALE_ABI,signer);

  Promise.all([saleRead.minUSDT(), saleRead.maxUSDT()]).then(function(vals){
    var minUSDT=vals[0], maxUSDT=vals[1];
    var amt=ethers.utils.parseUnits(amountStr.replace(',', '.'),USDT_DEC);
    if (amt.lt(minUSDT)) return setStatus("Monto menor al mínimo permitido.","warn");
    if (amt.gt(maxUSDT)) return setStatus("Monto mayor al máximo permitido.","warn");
    if (USDT_ALLOW.lt && USDT_ALLOW.lt(amt)) return setStatus("Falta aprobar suficiente USDT.","warn");

    setStatus("Enviando compra… firma en tu wallet.","warn");
    $("btnBuy").disabled=true;
    presale.buyWithUSDT(amt).then(function(tx){ return tx.wait(); })
      .then(function(){ setStatus("¡Compra exitosa! Recibirás tus BNC en tu wallet.","ok"); return refreshBalances(); })
      .catch(function(err){ setStatus((err && (err.data && err.data.message || err.message)) || "La compra no se pudo completar.","err"); })
      .finally(function(){
        var v=$("usdtInput").value.trim();
        var req=v && Number(v)>0 ? ethers.utils.parseUnits(v.replace(',', '.'),USDT_DEC) : null;
        updateApprovalUI(req);
      });
  }).catch(function(){ setStatus("No se pudo leer límites de preventa.","err"); });
}

/* ========= Eventos ========= */
$("btnConnect").addEventListener("click", connectWalletUniversal);
$("btnSwitch").addEventListener("click",  switchToBSC);
$("usdtInput").addEventListener("input",  onUsdtInput);
$("btnApprove").addEventListener("click", approveUSDT);
$("btnBuy").addEventListener("click",     buyBNC);

/* ========= Precarga ========= */
loadOnchainParams().then(onUsdtInput);
</script>
</body>
</html>
