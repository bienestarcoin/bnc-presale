<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bienestar Coin (BNC) – Preventa Oficial</title>
  <meta name="description" content="Preventa oficial de Bienestar Coin (BNC) en BNB Smart Chain. 1 USDT = 20 BNC." />

  <!-- Ethers.js v5 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js" defer></script>

  <!-- Opcional: mejoras de red para los CDNs -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="preconnect" href="https://unpkg.com" crossorigin>

  <style>
    :root{
      --gold:#d4af37; --gold-2:#f4d35e; --black:#0b0b0b; --card:#151515;
      --text:#eaeaea; --muted:#bdbdbd; --ok:#6ee7b7; --warn:#f59e0b; --err:#f87171;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial;
      background: radial-gradient(1200px 500px at 50% -10%, rgba(212,175,55,.15), transparent 70%), var(--black);
      color:var(--text); min-height:100vh; display:flex; flex-direction:column; align-items:center;
    }
    header{width:100%; max-width:980px; padding:24px 16px 8px; display:flex; align-items:center; gap:14px;}
    header img.logo{ width:56px; height:56px; border-radius:50%; object-fit:cover;
      box-shadow:0 0 0 2px rgba(212,175,55,.35), 0 10px 24px rgba(0,0,0,.4);}
    h1{font-size:clamp(22px,3.5vw,30px); margin:0}
    .sub{ color:var(--muted); margin-top:4px; font-size:14px }
    .card{
      width:100%; max-width:980px; margin:18px 16px; padding:18px;
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00)), var(--card);
      border:1px solid rgba(212,175,55,.25); border-radius:14px;
      box-shadow:0 6px 30px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.02);
    }
    .grid{ display:grid; gap:16px; grid-template-columns: 1fr 1fr; }
    @media (max-width:820px){ .grid{ grid-template-columns:1fr; } }
    .row{display:flex; gap:10px; align-items:center; justify-content:space-between}
    .row label{font-size:13px; color:var(--muted)}
    input[type="number"], input[type="text"]{
      width:100%; background:#0f0f0f; color:var(--text); border:1px solid rgba(212,175,55,.25);
      border-radius:10px; padding:12px 14px; font-size:16px; outline:none;
    }
    input[readonly]{opacity:.85}
    .btn{
      width:100%; padding:12px 16px; font-weight:600; font-size:15px; border:none; border-radius:10px; cursor:pointer;
      background: linear-gradient(90deg, var(--gold), var(--gold-2)); color:#151515; box-shadow:0 8px 24px rgba(212,175,55,.25);
      transition: transform .05s ease, filter .15s ease;
    }
    .btn:hover{ filter:brightness(1.03) } .btn:active{ transform:translateY(1px) }
    .btn.alt{ background:#1d1d1d; color:var(--text); border:1px solid rgba(212,175,55,.25); box-shadow:none; }
    .pill{ display:inline-flex; align-items:center; gap:8px; font-size:13px; padding:8px 12px; border-radius:999px;
      border:1px solid rgba(212,175,55,.25); background:#101010; color:var(--muted); }
    .status{margin-top:12px; font-size:14px} .status.ok{color:var(--ok)} .status.warn{color:var(--warn)} .status.err{color:var(--err)}
    footer{ width:100%; max-width:980px; padding:8px 16px 24px; color:var(--muted); font-size:13px }
    code.addr{color:#ffd166}
    .mini{ font-size:13px; color:var(--muted); display:grid; grid-template-columns:auto 1fr; gap:6px 12px; }
    .oktag{ display:inline-block; padding:3px 8px; border-radius:999px; background:#0f1a14; border:1px solid rgba(110,231,183,.35); color:var(--ok); font-size:12px; }
    .notag{ display:inline-block; padding:3px 8px; border-radius:999px; background:#1a1410; border:1px solid rgba(245,158,11,.35); color:var(--warn); font-size:12px; }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; }
  </style>
</head>
<body>

  <header>
    <img class="logo" src="./logo.png" alt="BNC" />
    <div>
      <h1>Bienestar Coin (BNC) – Preventa Oficial</h1>
      <div class="sub">1 USDT = <b>20 BNC</b> · Mín: 5 USDT · Máx: 50,000 USDT · Red: <b>BSC</b></div>
    </div>
  </header>

  <section class="card">
    <div class="grid">
      <div style="display:flex; flex-direction:column; gap:12px">
        <div class="row">
          <button id="btnConnect" class="btn">Conectar Wallet</button>
          <button id="btnSwitch"  class="btn alt">Cambiar a BSC</button>
        </div>

        <div class="row">
          <span class="pill">Wallet: <b id="walletShort">–</b></span>
          <span class="pill">Red: <b id="chainName">–</b></span>
        </div>

        <label>Monto USDT</label>
        <input id="usdtInput" type="number" min="0" step="0.01" placeholder="Ej. 5" />

        <label>Recibirás BNC</label>
        <input id="bncOutput" type="text" readonly placeholder="0" />
      </div>

      <div style="display:flex; flex-direction:column; gap:12px">
        <button id="btnApprove" class="btn">1) Aprobar USDT</button>
        <button id="btnBuy" class="btn" disabled>2) Comprar BNC</button>

        <div id="status" class="status">Estado: –</div>

        <div class="card" style="margin:0; padding:12px">
          <div style="font-size:13px; color:var(--muted); line-height:1.5">
            <div>Contrato <b>BNC</b>: <code class="addr" id="addrBNC"></code></div>
            <div><b>USDT</b>: <code class="addr" id="addrUSDT"></code></div>
            <div><b>Preventa</b>: <code class="addr" id="addrPresale"></code></div>
          </div>
        </div>

        <div class="card" style="margin:0; padding:12px">
          <div class="mini">
            <span><b>Balance USDT:</b></span> <span id="miniBalance">—</span>
            <span><b>Allowance (a Preventa):</b></span> <span id="miniAllowance">—</span>
            <span><b>Requerido para comprar:</b></span> <span id="miniRequired">—</span>
            <span><b>Estado aprobación:</b></span> <span id="miniApproveState"><span class="notag">Falta aprobar</span></span>
          </div>
        </div>

      </div>
    </div>
  </section>

  <footer>© Bienestar Coin · Esta dApp es de preventa. Revisa siempre la dirección de contrato.</footer>

<script>
/* =========================
   CONFIGURACIÓN DEL PROYECTO
   ========================= */
const ADDR_BNC     = "0xDa7A76879F12824C5E96985F794CDE4F90869D2E";     // Token BNC (BEP-20)
const ADDR_USDT    = "0x55d398326f99059fF775485246999027B3197955";     // USDT BEP-20 (18 dec en BSC-PEG)
const ADDR_PRESALE = "0xCcAc983D6e111f6f21384E40FA1e305C70844fC4";     // Contrato de preventa
const CHAIN_ID     = 56;                                               // BSC Mainnet
const WC_PROJECT_ID = "b4feca4564a2101fb8925873d5186274";              // Tu Project ID

/* ===== ABIs mínimos ===== */
const ERC20_ABI = [
  "function decimals() view returns (uint8)",
  "function balanceOf(address) view returns (uint256)",
  "function allowance(address owner, address spender) view returns (uint256)",
  "function approve(address spender, uint256 amount) returns (bool)"
];
const PRESALE_ABI = [
  "function buyWithUSDT(uint256 usdtAmount) external",
  "function minUSDT() view returns (uint256)",
  "function maxUSDT() view returns (uint256)",
  "function hardCapUSDT() view returns (uint256)",
  "function rate() view returns (uint256)" // 1 USDT => rate BNC (entero)
];

/* ===== Estado de la app ===== */
let provider, signer, account = null;
let wcProvider;
let USDT_DEC = 18, BNC_DEC = 18;
let RATE_SCALED = ethers.utils.parseUnits("20", 18); // fallback 20e18
let USDT_BAL = ethers.constants.Zero;
let USDT_ALLOW = ethers.constants.Zero;

/* ===== UI helpers ===== */
const $ = (id) => document.getElementById(id);
const statusEl = $("status");
$("addrBNC").textContent     = ADDR_BNC;
$("addrUSDT").textContent    = ADDR_USDT;
$("addrPresale").textContent = ADDR_PRESALE;

function setStatus(msg, type=""){ statusEl.textContent = "Estado: " + msg; statusEl.className="status "+(type||""); }
function shortAddr(a){ return a ? a.slice(0,6)+"…"+a.slice(-4) : "–"; }
function chainName(id){ return Number(id)===56 ? "BSC" : Number(id)===97 ? "BSC Testnet" : "Chain "+id; }
function fmtLocaleFromUnits(bn, dec){
  try{
    const s = ethers.utils.formatUnits(bn, dec);
    const n = Number(s);
    return isNaN(n) ? s : n.toLocaleString("es-MX", { maximumFractionDigits: 6 });
  }catch{ return "—"; }
}

/* ========= CARGADOR ROBUSTO DE WALLETCONNECT (UMD) ========= */
function getWCEthereumProviderInit(){
  if(window.WalletConnectProvider?.EthereumProvider?.init) return window.WalletConnectProvider.EthereumProvider.init;
  if(window.WalletConnectProvider?.default?.init)         return window.WalletConnectProvider.default.init;
  if(window.WalletConnectEthereumProvider?.init)          return window.WalletConnectEthereumProvider.init;
  if(window.EthereumProvider?.init)                       return window.EthereumProvider.init;
  return null;
}

function loadScriptOnce(src){
  return new Promise((resolve,reject)=>{
    // si ya existe exactamente ese src, resolvemos
    const existing=[...document.scripts].find(s=>s.src===src);
    if(existing){ existing.addEventListener('load',()=>resolve()); existing.addEventListener('error',()=>reject(new Error('load error'))); if(existing.readyState==='complete') resolve(); return; }
    const s=document.createElement('script');
    s.src=src; s.async=true; s.defer=true; s.crossOrigin='anonymous';
    s.onload=()=>resolve();
    s.onerror=()=>reject(new Error('error: '+src));
    document.head.appendChild(s);
  });
}

async function ensureWalletConnectUMD(){
  // si ya está disponible, salimos
  if (getWCEthereumProviderInit()) return true;

  // intentamos jsDelivr (versión fijada)
  const cdn1 = "https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider@2.11.2/dist/index.umd.min.js";
  // fallback a unpkg
  const cdn2 = "https://unpkg.com/@walletconnect/ethereum-provider@2.11.2/dist/index.umd.min.js";

  try{
    await loadScriptOnce(cdn1);
  }catch(_){}
  // si tras jsDelivr sigue sin estar, probamos unpkg
  if(!getWCEthereumProviderInit()){
    try{ await loadScriptOnce(cdn2); }catch(_){}
  }

  // resultado final:
  return !!getWCEthereumProviderInit();
}
/* ========================================================= */

/* ===== Detectar proveedor inyectado ===== */
function getInjectedProvider(){
  if(!window.ethereum) return null;
  if(window.ethereum.providers?.length){
    return window.ethereum.providers.find(p=>p.isMetaMask)||window.ethereum.providers[0];
  }
  return window.ethereum;
}

/* ===== WalletConnect init usando el cargador robusto ===== */
async function initWC(){
  if(wcProvider) return wcProvider;

  const ok = await ensureWalletConnectUMD();
  if(!ok) throw new Error("No se encontró WalletConnect EthereumProvider (UMD). Revisa bloqueos del navegador.");

  const wcInit = getWCEthereumProviderInit(); // ya debe existir
  wcProvider = await wcInit({
    projectId: WC_PROJECT_ID,
    chains: [56],
    rpcMap: { 56: "https://bsc-dataseed.binance.org/" },
    showQrModal: true,
    methods: [
      "eth_sendTransaction","personal_sign","eth_signTypedData",
      "eth_requestAccounts","wallet_switchEthereumChain","wallet_addEthereumChain"
    ],
    events: ["chainChanged","accountsChanged","disconnect"]
  });
  return wcProvider;
}

/* ===== Conectar Universal (inyectado -> fallback WC) ===== */
async function connectWalletUniversal(){
  try{
    setStatus("Conectando…","warn");

    const injected=getInjectedProvider();
    if(injected){
      provider=new ethers.providers.Web3Provider(injected,"any");
      await provider.send("eth_requestAccounts",[]);
    }else{
      const wc=await initWC();
      await wc.enable(); // QR / deeplink
      provider=new ethers.providers.Web3Provider(wc,"any");
    }

    signer=provider.getSigner();
    account=await signer.getAddress();
    $("walletShort").textContent=shortAddr(account);

    // Forzar/validar BSC
    let net=await provider.getNetwork();
    if(Number(net.chainId)!==56){
      try{
        await provider.provider.request({ method:"wallet_switchEthereumChain", params:[{ chainId:"0x38" }] });
      }catch(e){
        if(e.code===4902){
          await provider.provider.request({
            method:"wallet_addEthereumChain",
            params:[{ chainId:"0x38", chainName:"BNB Smart Chain",
              nativeCurrency:{ name:"BNB", symbol:"BNB", decimals:18 },
              rpcUrls:["https://bsc-dataseed.binance.org/"], blockExplorerUrls:["https://bscscan.com/"] }]
          });
        }else{ throw e; }
      }
      net=await provider.getNetwork();
    }
    $("chainName").textContent=chainName(net.chainId);

    // Listeners
    provider.provider?.on?.("accountsChanged",(a)=>{ if(a&&a[0]){ account=a[0]; $("walletShort").textContent=shortAddr(account); refreshBalances(); }});
    provider.provider?.on?.("chainChanged",async (cid)=>{ $("chainName").textContent=chainName(Number(cid)); await refreshBalances(); });
    provider.provider?.on?.("disconnect",()=>{ provider=signer=account=null; $("walletShort").textContent="–"; $("chainName").textContent="–"; setStatus("Desconectado."); resetMini(); });

    setStatus("Wallet conectada.","ok");

    // Cargar parámetros y refrescar cotización + balances
    await loadOnchainParams();
    onUsdtInput();
    await refreshBalances();

  }catch(e){
    const msg = e?.data?.message || e?.message || String(e);
    setStatus("No se pudo conectar: "+msg,"err");
    console.error("connectWalletUniversal error:",e);
  }
}

/* ===== Cambiar a BSC (botón manual) ===== */
async function switchToBSC(){
  try{
    if (!provider) return setStatus("Conecta tu wallet primero.", "warn");
    await provider.provider.request({ method:"wallet_switchEthereumChain", params:[{ chainId:"0x38" }] });
    $("chainName").textContent = "BSC";
    setStatus("Red cambiada a BSC.", "ok");
    await refreshBalances();
  }catch(err){
    if (err.code === 4902){
      try{
        await provider.provider.request({
          method:"wallet_addEthereumChain",
          params:[{ chainId:"0x38", chainName:"BNB Smart Chain",
            nativeCurrency:{ name:"BNB", symbol:"BNB", decimals:18 },
            rpcUrls:["https://bsc-dataseed.binance.org/"], blockExplorerUrls:["https://bscscan.com/"] }]
        });
        setStatus("BSC agregada. Intenta de nuevo.", "ok");
      }catch(e){ setStatus("No se pudo agregar BSC.", "err"); }
    }else{
      setStatus("No se pudo cambiar a BSC: " + (err?.message||err), "err");
    }
  }
}

/* ===== Leer parámetros on-chain (decimales y rate) ===== */
async function loadOnchainParams(){
  try{
    const rpc = provider ?? new ethers.providers.JsonRpcProvider("https://bsc-dataseed.binance.org/");
    const usdt  = new ethers.Contract(ADDR_USDT, ERC20_ABI, rpc);
    const bnc   = new ethers.Contract(ADDR_BNC,  ERC20_ABI, rpc);
    const sale  = new ethers.Contract(ADDR_PRESALE, PRESALE_ABI, rpc);

    USDT_DEC = await usdt.decimals().then(Number).catch(()=>18);
    BNC_DEC  = await bnc.decimals().then(Number).catch(()=>18);

    // rate() plano -> escalar a 1e18
    const r = await sale.rate().catch(()=>ethers.constants.Zero);
    RATE_SCALED = r.gt(0) ? r.mul(ethers.constants.WeiPerEther) : ethers.utils.parseUnits("20", 18);
  }catch(e){
    console.warn("No se pudo leer parámetros on-chain, usando defaults.", e);
  }
}

/* ===== Cálculo en vivo (USDT -> BNC) ===== */
function onUsdtInput(){
  const v = $("usdtInput").value.trim();
  if (!v || Number(v) <= 0){ $("bncOutput").value = "0"; updateApprovalUI(null); return; }

  const rateScaled = RATE_SCALED.gt(0) ? RATE_SCALED : ethers.utils.parseUnits("20", 18);

  let usdtWei;
  try{ usdtWei = ethers.utils.parseUnits(v.replace(',', '.'), USDT_DEC); }
  catch{ $("bncOutput").value="0"; updateApprovalUI(null); return; }

  let tokensWei;
  if (BNC_DEC >= USDT_DEC) {
    const scale = ethers.BigNumber.from(10).pow(BNC_DEC - USDT_DEC);
    tokensWei = usdtWei.mul(rateScaled).mul(scale).div(ethers.constants.WeiPerEther);
  } else {
    const scale = ethers.BigNumber.from(10).pow(USDT_DEC - BNC_DEC);
    tokensWei = usdtWei.mul(rateScaled).div(scale).div(ethers.constants.WeiPerEther);
  }

  const pretty = Number(ethers.utils.formatUnits(tokensWei, BNC_DEC));
  $("bncOutput").value = isFinite(pretty) ? pretty.toLocaleString("es-MX", { maximumFractionDigits: 6 }) : "0";

  updateApprovalUI(usdtWei);
}

/* ===== Refrescar Balance y Allowance ===== */
async function refreshBalances(){
  try{
    if (!provider || !account) { resetMini(); return; }
    const rpc = provider;
    const usdt = new ethers.Contract(ADDR_USDT, ERC20_ABI, rpc);
    USDT_BAL   = await usdt.balanceOf(account);
    USDT_ALLOW = await usdt.allowance(account, ADDR_PRESALE);

    $("miniBalance").textContent  = fmtLocaleFromUnits(USDT_BAL, USDT_DEC) + " USDT";
    $("miniAllowance").textContent= fmtLocaleFromUnits(USDT_ALLOW, USDT_DEC) + " USDT";

    const v = $("usdtInput").value.trim();
    const req = v && Number(v)>0 ? ethers.utils.parseUnits(v.replace(',', '.'), USDT_DEC) : null;
    updateApprovalUI(req);
  }catch(e){
    console.warn("No se pudo leer balance/allowance", e);
    resetMini();
  }
}

function resetMini(){
  $("miniBalance").textContent  = "—";
  $("miniAllowance").textContent= "—";
  $("miniRequired").textContent = "—";
  $("miniApproveState").innerHTML = '<span class="notag">Falta aprobar</span>';
  $("btnBuy").disabled = true;
}

/* ===== Actualizar UI de aprobación ===== */
function updateApprovalUI(requiredWei){
  try{
    if (!requiredWei || requiredWei.lte(0)) {
      $("miniRequired").textContent = "—";
      $("miniApproveState").innerHTML = '<span class="notag">Falta aprobar</span>';
      $("btnBuy").disabled = true;
      return;
    }
    $("miniRequired").textContent = fmtLocaleFromUnits(requiredWei, USDT_DEC) + " USDT";

    const enoughBalance  = USDT_BAL.gte(requiredWei);
    const enoughAllowance= USDT_ALLOW.gte(requiredWei);

    if (enoughAllowance) {
      $("miniApproveState").innerHTML = '<span class="oktag">Aprobación lista ✓</span>';
      $("btnBuy").disabled = !enoughBalance;
    } else {
      $("miniApproveState").innerHTML = '<span class="notag">Falta aprobar</span>';
      $("btnBuy").disabled = true;
    }
  }catch{
    $("miniApproveState").innerHTML = '<span class="notag">Falta aprobar</span>';
    $("btnBuy").disabled = true;
  }
}

/* ===== Aprobar USDT ===== */
async function approveUSDT(){
  try{
    if (!provider || !signer) return setStatus("Conecta tu wallet primero.", "warn");

    const amountStr = $("usdtInput").value.trim();
    if (!amountStr || Number(amountStr) <= 0) return setStatus("Ingresa un monto válido.", "warn");

    const saleRead = new ethers.Contract(ADDR_PRESALE, PRESALE_ABI, provider);
    const minUSDT  = await saleRead.minUSDT();
    const maxUSDT  = await saleRead.maxUSDT();

    const amt = ethers.utils.parseUnits(amountStr.replace(',', '.'), USDT_DEC);
    if (amt.lt(minUSDT)) return setStatus("Monto menor al mínimo permitido.", "warn");
    if (amt.gt(maxUSDT)) return setStatus("Monto mayor al máximo permitido.", "warn");

    const usdt = new ethers.Contract(ADDR_USDT, ERC20_ABI, signer);
    setStatus("Aprobando USDT… firma en tu wallet.", "warn");
    const tx = await usdt.approve(ADDR_PRESALE, amt);
    $("btnApprove").disabled = true;
    await tx.wait();
    setStatus("USDT aprobado correctamente.", "ok");

    // Actualiza allowance y UI
    USDT_ALLOW = await usdt.allowance(account, ADDR_PRESALE);
    $("miniAllowance").textContent= fmtLocaleFromUnits(USDT_ALLOW, USDT_DEC) + " USDT";
    updateApprovalUI(amt);
  }catch(err){
    const m = err?.data?.message || err?.message || "Fallo al aprobar USDT.";
    setStatus(m, "err");
    console.error(err);
  }finally{
    $("btnApprove").disabled = false;
  }
}

/* ===== Comprar BNC ===== */
async function buyBNC(){
  try{
    if (!provider || !signer) return setStatus("Conecta tu wallet primero.", "warn");

    const amountStr = $("usdtInput").value.trim();
    if (!amountStr || Number(amountStr) <= 0) return setStatus("Ingresa un monto válido.", "warn");

    const saleRead = new ethers.Contract(ADDR_PRESALE, PRESALE_ABI, provider);
    const minUSDT  = await saleRead.minUSDT();
    const maxUSDT  = await saleRead.maxUSDT();

    const amt = ethers.utils.parseUnits(amountStr.replace(',', '.'), USDT_DEC);
    if (amt.lt(minUSDT)) return setStatus("Monto menor al mínimo permitido.", "warn");
    if (amt.gt(maxUSDT)) return setStatus("Monto mayor al máximo permitido.", "warn");

    if (USDT_ALLOW.lt(amt)) {
      setStatus("Falta aprobar suficiente USDT para este monto.", "warn");
      return;
    }

    const presale = new ethers.Contract(ADDR_PRESALE, PRESALE_ABI, signer);
    setStatus("Enviando compra… firma en tu wallet.", "warn");
    $("btnBuy").disabled = true;
    const tx = await presale.buyWithUSDT(amt);
    await tx.wait();
    setStatus("¡Compra exitosa! Recibirás tus BNC en tu wallet.", "ok");

    await refreshBalances();
  }catch(err){
    const m = err?.data?.message || err?.message || "La compra no se pudo completar.";
    setStatus(m, "err");
    console.error(err);
  }finally{
    const v = $("usdtInput").value.trim();
    const req = v && Number(v)>0 ? ethers.utils.parseUnits(v.replace(',', '.'), USDT_DEC) : null;
    updateApprovalUI(req);
  }
}

/* ===== Eventos UI ===== */
$("btnConnect").addEventListener("click", connectWalletUniversal);
$("btnSwitch").addEventListener("click",  switchToBSC);
$("usdtInput").addEventListener("input",  onUsdtInput);
$("btnApprove").addEventListener("click", approveUSDT);
$("btnBuy").addEventListener("click",     buyBNC);

/* Precarga (rate/decimals) y calcula inicial */
loadOnchainParams().then(onUsdtInput);
</script>
</body>
</html>
