<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bienestar Coin (BNC) – Preventa Oficial</title>
  <style>
    body{margin:0;background:#0d1b2a;color:#e5e5e5;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:880px;margin:40px auto;padding:0 16px}
    h1{font-weight:700;margin:0 0 6px}
    .sub{opacity:.8;margin:0 0 24px}
    .card{background:#14243a;border:1px solid #243b55;border-radius:12px;padding:18px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:10px 0}
    .col{flex:1 1 220px}
    input{width:100%;padding:10px 12px;border-radius:8px;border:1px solid #2f4b6a;background:#0f2034;color:#e5e5e5}
    button{width:100%;padding:12px;border:0;border-radius:8px;background:#1ea7fd;color:#07213a;font-weight:700;cursor:pointer}
    button.secondary{background:#264b73;color:#e5e5e5}
    .muted{opacity:.8;font-size:14px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .foot{margin-top:14px;font-size:13px;opacity:.8}
    .ok{color:#8ef59a}
    .bad{color:#ff7676}
  </style>

  <!-- ethers.js -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
  <!-- WalletConnect v1 provider (para web3modal v1) -->
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.7.8/dist/umd/index.min.js"></script>
  <!-- web3modal v1 (sencillo y compatible con muchas wallets) -->
  <script src="https://cdn.jsdelivr.net/npm/web3modal@1.9.12/dist/index.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>Bienestar Coin (BNC) – Preventa Oficial</h1>
    <p class="sub">1 USDT = <b>20 BNC</b> · Min: 5 USDT · Máx: 50,000 USDT · Red: <b>BSC</b></p>

    <div class="card">
      <div class="row">
        <div class="col"><button id="btnConnect">Conectar Wallet</button></div>
        <div class="col"><button id="btnSwitch" class="secondary">Cambiar a BSC</button></div>
      </div>

      <div class="row muted">
        <div class="col">Wallet: <span id="lbWallet" class="mono">-</span></div>
        <div class="col">Red: <span id="lbChain" class="mono">-</span></div>
      </div>

      <div class="row">
        <div class="col">
          <label class="muted">Monto USDT</label>
          <input id="inpUsdt" placeholder="Ej. 5" inputmode="decimal" />
        </div>
        <div class="col">
          <label class="muted">Recibirás BNC</label>
          <input id="inpBnc" disabled />
        </div>
      </div>

      <div class="row">
        <div class="col"><button id="btnApprove" class="secondary">1) Aprobar USDT</button></div>
        <div class="col"><button id="btnBuy">2) Comprar BNC</button></div>
      </div>

      <div class="foot">
        Estado: <span id="lbStatus">–</span>
      </div>
    </div>

    <p class="foot mono">
      Contrato BNC: 0xDa7A76879F12824C5e96985F794CDE4F90869D2E ·
      USDT: 0x55d398326f99059fF775485246999027B3197955 ·
      Preventa: 0xCcAc983D6e111f6f21384E40FA1e305C70844fC4
    </p>
  </div>

<script>
/** ====== CONFIG ====== **/
const CHAIN_ID = 56; // BSC Mainnet
const CHAIN_PARAMS = {
  chainId: '0x38',
  chainName: 'Binance Smart Chain',
  nativeCurrency: { name:'BNB', symbol:'BNB', decimals:18 },
  rpcUrls: ['https://bsc-dataseed.binance.org'],
  blockExplorerUrls: ['https://bscscan.com']
};

const ADDR = {
  tokenBNC: '0xDa7A76879F12824C5e96985F794CDE4F90869D2E',
  usdt:     '0x55d398326f99059fF775485246999027B3197955',
  presale:  '0xCcAc983D6e111f6f21384E40FA1e305C70844fC4'
};
const RATE_TOKENS_PER_USDT = ethers.BigNumber.from('20'); // 20 BNC por 1 USDT
const MIN_USDT = ethers.utils.parseUnits('5', 18);
const MAX_USDT = ethers.utils.parseUnits('50000', 18);

/** ABIs mínimos **/
const ERC20_ABI = [
  "function decimals() view returns (uint8)",
  "function balanceOf(address) view returns (uint256)",
  "function allowance(address owner,address spender) view returns (uint256)",
  "function approve(address spender,uint256 amount) returns (bool)"
];
const PRESALE_ABI = [
  "function buyWithUSDT(uint256 usdtAmount) external",
];

/** ====== ESTADO WEB3 ====== **/
let web3Modal, extProvider, provider, signer, account, chainId;
let usdt, presale;

function setStatus(msg, ok=false, bad=false){
  const el = document.getElementById('lbStatus');
  el.textContent = msg;
  el.className = ok ? 'ok' : bad ? 'bad' : '';
}

function fmtAddr(a){ return a ? a.slice(0,6)+'…'+a.slice(-4) : '-'; }
function fmtChain(id){ return id===56?'BSC (56)':id===97?'BSC Testnet (97)':String(id); }

async function ensureBSC(){
  if(!window.ethereum) return;
  try{
    const cid = await provider.send('eth_chainId',[]);
    if (parseInt(cid,16) !== CHAIN_ID){
      await window.ethereum.request({ method:'wallet_addEthereumChain', params:[CHAIN_PARAMS] });
    }
  }catch(e){ console.log(e); }
}

/** ====== CÁLCULO EN TIEMPO REAL ====== **/
document.getElementById('inpUsdt').addEventListener('input', ()=>{
  const v = document.getElementById('inpUsdt').value.trim();
  if(!v){ document.getElementById('inpBnc').value = ''; return; }
  const num = Number(v);
  if (isNaN(num)) { document.getElementById('inpBnc').value=''; return; }
  document.getElementById('inpBnc').value = String(num * RATE_TOKENS_PER_USDT.toNumber());
});

/** ====== CONEXIÓN ====== **/
function initWeb3Modal(){
  const providerOptions = {
    walletconnect: {
      package: window.WalletConnectProvider.default,
      options: {
        rpc: { 56: 'https://bsc-dataseed.binance.org' },
        chainId: 56
      }
    }
  };
  web3Modal = new window.Web3Modal.default({
    cacheProvider: false,
    providerOptions,
    theme: "dark"
  });
}

async function connect(){
  try{
    setStatus('Conectando…');
    if (window.ethereum){
      // Intento directo (MetaMask/Trust u otras inyectadas)
      extProvider = window.ethereum;
      await extProvider.request({ method: 'eth_requestAccounts' });
    }else{
      // Abrir selector (WalletConnect)
      if(!web3Modal) initWeb3Modal();
      extProvider = await web3Modal.connect();
    }

    provider = new ethers.providers.Web3Provider(extProvider);
    signer   = provider.getSigner();
    account  = await signer.getAddress();
    chainId  = (await provider.getNetwork()).chainId;

    document.getElementById('lbWallet').textContent = fmtAddr(account);
    document.getElementById('lbChain').textContent  = fmtChain(chainId);

    if (chainId !== CHAIN_ID){
      setStatus('Red incorrecta. Pulsa "Cambiar a BSC".', false, true);
    } else {
      setStatus('Conectado.');
    }

    usdt    = new ethers.Contract(ADDR.usdt, ERC20_ABI, signer);
    presale = new ethers.Contract(ADDR.presale, PRESALE_ABI, signer);

    // Reaccionar a cambios de red/cuenta
    if (extProvider && extProvider.on){
      extProvider.on('accountsChanged', ()=>window.location.reload());
      extProvider.on('chainChanged',   ()=>window.location.reload());
    }
  }catch(e){
    console.error(e);
    setStatus('Error al conectar: '+ (e.message || e), false, true);
  }
}

async function switchToBSC(){
  if(!window.ethereum){ setStatus('No hay wallet inyectada.', false, true); return; }
  try{
    await window.ethereum.request({ method:'wallet_addEthereumChain', params:[CHAIN_PARAMS] });
    setStatus('Red cambiada a BSC.');
  }catch(e){
    setStatus('No se pudo cambiar de red: '+(e.message||e), false, true);
  }
}

/** ====== APROBAR & COMPRAR ====== **/
async function approveUSDT(){
  try{
    if (!signer) return setStatus('Conecta tu wallet primero.', false, true);
    if (chainId !== CHAIN_ID) return setStatus('Cambia a BSC.', false, true);

    const v = document.getElementById('inpUsdt').value.trim();
    if(!v) return setStatus('Ingresa monto USDT.', false, true);

    const usdtAmount = ethers.utils.parseUnits(v, 18);
    if (usdtAmount.lt(MIN_USDT)) return setStatus('Mínimo: 5 USDT.', false, true);
    if (usdtAmount.gt(MAX_USDT)) return setStatus('Máximo: 50,000 USDT.', false, true);

    setStatus('Enviando aprobación…');
    const tx = await usdt.approve(ADDR.presale, usdtAmount);
    await tx.wait();
    setStatus('USDT aprobado ✔️', true, false);
  }catch(e){
    console.error(e);
    setStatus('Error en approve: ' + (e.data?.message || e.message || e), false, true);
  }
}

async function buyBNC(){
  try{
    if (!signer) return setStatus('Conecta tu wallet primero.', false, true);
    if (chainId !== CHAIN_ID) return setStatus('Cambia a BSC.', false, true);

    const v = document.getElementById('inpUsdt').value.trim();
    if(!v) return setStatus('Ingresa monto USDT.', false, true);

    const usdtAmount = ethers.utils.parseUnits(v, 18);
    if (usdtAmount.lt(MIN_USDT)) return setStatus('Mínimo: 5 USDT.', false, true);
    if (usdtAmount.gt(MAX_USDT)) return setStatus('Máximo: 50,000 USDT.', false, true);

    setStatus('Comprando BNC…');
    const tx = await presale.buyWithUSDT(usdtAmount);
    await tx.wait();
    setStatus('Compra completada ✔️ Revisa tu BNC en la wallet.', true, false);
  }catch(e){
    console.error(e);
    setStatus('Error en compra: ' + (e.data?.message || e.message || e), false, true);
  }
}

/** ====== UI HOOKS ====== **/
document.getElementById('btnConnect').addEventListener('click', async ()=>{
  if(!web3Modal) initWeb3Modal();
  await connect();
});
document.getElementById('btnSwitch').addEventListener('click', switchToBSC);
document.getElementById('btnApprove').addEventListener('click', approveUSDT);
document.getElementById('btnBuy').addEventListener('click', buyBNC);

// Si ya hay wallet en el navegador, preparamos provider para poder cambiar de red
if (window.ethereum){
  provider = new ethers.providers.Web3Provider(window.ethereum);
}
</script>
</body>
</html>
