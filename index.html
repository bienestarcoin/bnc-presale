<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Bienestar Coin (BNC) ‚Äì Preventa Oficial</title>
<!-- Ethers v5 UMD -->
<script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<!-- WalletConnect Ethereum Provider v2 (incluye modal) -->
<script src="https://unpkg.com/@walletconnect/ethereum-provider@2/dist/index.umd.js"></script>
<style>
  body{margin:0;background:#0e1621;color:#e6f1ff;font-family:system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial}
  .wrap{max-width:860px;margin:40px auto;padding:0 16px}
  h1{margin:0 0 8px}
  .sub{opacity:.85;margin:0 0 24px}
  .card{background:#122033;border:1px solid #1b2a41;border-radius:12px;padding:20px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .row{margin:10px 0}
  .btn{width:100%;padding:12px 14px;border:0;border-radius:10px;background:#1d6fff;color:#fff;font-weight:600;cursor:pointer}
  .btn.secondary{background:#253a5a}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  label{display:block;font-size:12px;opacity:.85;margin-bottom:6px}
  input, .ro{width:100%;padding:12px 12px;border:1px solid #243652;background:#0f1b2b;color:#e6f1ff;border-radius:10px}
  .muted{opacity:.8;font-size:13px}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  .foot{opacity:.8;margin-top:14px;font-size:12px}
  .ok{color:#39d98a} .bad{color:#ff7b7b}
</style>
</head>
<body>
<div class="wrap">
  <h1>Bienestar Coin (BNC) ‚Äì Preventa Oficial</h1>
  <p class="sub">1 USDT = <b>20 BNC</b> ¬∑ Min: <b>5</b> USDT ¬∑ M√°x: <b>50,000</b> USDT ¬∑ Red: <b>BSC</b></p>

  <div class="card">
    <div class="grid">
      <button id="btnConnect" class="btn">Conectar Wallet</button>
      <button id="btnSwitch" class="btn secondary">Cambiar a BSC</button>
    </div>

    <div class="grid" style="margin-top:12px">
      <div class="ro"><b>Wallet:</b> <span id="wallet">‚Äî</span></div>
      <div class="ro"><b>Red:</b> <span id="net">‚Äî</span></div>
    </div>

    <div class="grid" style="margin-top:12px">
      <div>
        <label for="usdtAmount">Monto USDT</label>
        <input id="usdtAmount" type="number" placeholder="Ej. 5" min="0" step="0.01">
      </div>
      <div>
        <label for="bncOut">Recibir√°s BNC</label>
        <input id="bncOut" type="text" placeholder="0" readonly>
      </div>
    </div>

    <div class="grid" style="margin-top:12px">
      <button id="btnApprove" class="btn secondary">1) Aprobar USDT</button>
      <button id="btnBuy" class="btn">2) Comprar BNC</button>
    </div>

    <div class="row muted"><b>Estado:</b> <span id="estado">‚Äî</span></div>

    <div class="foot mono">
      Contrato <b>BNC</b>: 0xDa7a76879F12824C5e96985F794CDE4F90869D2E ¬∑
      <b>USDT</b>: 0x55d398326f99059fF775485246999027B3197955 ¬∑
      <b>Preventa</b>: 0xCcAc983D6e111f6f21384E40FA1e305C70844fC4
    </div>
  </div>
</div>

<script>
/* ========= CONFIG ========= */
const BNC  = "0xDa7a76879F12824C5e96985F794CDE4F90869D2E";
const USDT = "0x55d398326f99059fF775485246999027B3197955"; // 18 dec en BSC
const PRESALE = "0xCcAc983D6e111f6f21384E40FA1e305C70844fC4";
const MIN_USDT = 5;
const MAX_USDT = 50000;
let RATE = 20; // fallback (se intentar√° leer del contrato)
const BSC_CHAIN_ID_HEX = "0x38"; // 56
const WC_PROJECT_ID = "PON_AQUI_TU_PROJECT_ID"; // <-- cambia esto

/* ========= ABIs m√≠nimos ========= */
const abiUSDT = [
  "function decimals() view returns (uint8)",
  "function allowance(address owner, address spender) view returns (uint256)",
  "function approve(address spender, uint256 amount) returns (bool)"
];
const abiPresale = [
  "function rate() view returns (uint256)",
  "function buyWithUSDT(uint256 usdtAmount) external",
  "function minUSDT() view returns (uint256)",
  "function maxUSDT() view returns (uint256)"
];

/* ========= Estado Web3 ========= */
let wcProvider;        // WalletConnect provider (si se usa)
let provider;          // Ethers provider
let signer;            // Ethers signer
let presaleRead;       // Contrato preventa (lecturas)
let presaleWrite;      // Contrato preventa (escrituras)
let usdtRead, usdtWrite;

const $ = (id)=>document.getElementById(id);
const walletEl = $("wallet"), netEl = $("net"), estadoEl = $("estado");
const amountInput = $("usdtAmount"), outInput = $("bncOut");

/* ========= Utilidades ========= */
function setStatus(msg, cls){
  estadoEl.className = cls || "";
  estadoEl.textContent = msg;
}
function fmt(n){ return Number(n).toLocaleString("en-US"); }

/* C√°lculo en vivo */
function refreshQuote(){
  const v = parseFloat(amountInput.value || "0");
  if(!isFinite(v) || v <= 0){ outInput.value = ""; return; }
  outInput.value = fmt(v * RATE);
  if(v < MIN_USDT) setStatus(`M√≠nimo: ${MIN_USDT} USDT`);
  else if(v > MAX_USDT) setStatus(`M√°ximo: ${MAX_USDT} USDT por wallet`);
  else setStatus("‚Äî");
}
amountInput.addEventListener("input", refreshQuote);

/* ========= Inicial: intentar provider inyectado para leer tasa ========= */
(async()=>{
  try{
    if(window.ethereum){
      const p = new ethers.providers.Web3Provider(window.ethereum);
      const presale = new ethers.Contract(PRESALE, abiPresale, p);
      const r = await presale.rate();
      RATE = Number(r);
      refreshQuote();
    }
  }catch(e){ console.log("No pude leer rate() a√∫n:", e); }
})();

/* ========= Conectar ========= */
async function connectAnyWallet(){
  try{
    // 1) Si hay inyectado (MetaMask/Trust/OKX/Bitget‚Ä¶), usarlo
    if(window.ethereum){
      await window.ethereum.request({ method: "eth_requestAccounts" });
      provider = new ethers.providers.Web3Provider(window.ethereum, "any");
      signer   = provider.getSigner();
    }else{
      // 2) Si no hay inyectado, abrir WalletConnect v2 (QR)
      wcProvider = await window.WalletConnectEthereumProvider.init({
        projectId: WC_PROJECT_ID,
        showQrModal: true,
        chains: [56], // BSC
        optionalChains: [56]
      });
      await wcProvider.enable();
      provider = new ethers.providers.Web3Provider(wcProvider, "any");
      signer   = provider.getSigner();
    }

    const addr = await signer.getAddress();
    walletEl.textContent = addr;

    const net = await provider.getNetwork();
    netEl.textContent = (net.chainId === 56) ? "BSC" : `Chain ${net.chainId}`;

    // Instancias de contratos
    presaleRead  = new ethers.Contract(PRESALE, abiPresale, provider);
    presaleWrite = new ethers.Contract(PRESALE, abiPresale, signer);
    usdtRead     = new ethers.Contract(USDT, abiUSDT, provider);
    usdtWrite    = new ethers.Contract(USDT, abiUSDT, signer);

    // Refrescar tasa real
    try{ RATE = Number(await presaleRead.rate()); refreshQuote(); }catch{}

    // Listeners (solo si hay inyectado)
    if(window.ethereum){
      window.ethereum.on("accountsChanged", (accs)=>{
        walletEl.textContent = accs && accs[0] ? accs[0] : "‚Äî";
      });
      window.ethereum.on("chainChanged", (cid)=>{
        netEl.textContent = (cid === BSC_CHAIN_ID_HEX) ? "BSC" : cid;
      });
    }

    setStatus("Conectado ‚úÖ", "ok");
  }catch(err){
    console.error(err);
    setStatus("No se pudo conectar la wallet", "bad");
  }
}

/* ========= Cambiar a BSC ========= */
async function switchToBSC(){
  try{
    if(!provider && window.ethereum){
      provider = new ethers.providers.Web3Provider(window.ethereum, "any");
    }
    if(!window.ethereum){ setStatus("Usa WalletConnect si no tienes inyectado", "bad"); return; }
    await window.ethereum.request({
      method: "wallet_switchEthereumChain",
      params: [{ chainId: BSC_CHAIN_ID_HEX }]
    });
    setStatus("Red cambiada a BSC ‚úÖ", "ok");
  }catch(e){
    // Si la red no est√° agregada
    if(e && e.code === 4902){
      try{
        await window.ethereum.request({
          method: "wallet_addEthereumChain",
          params: [{
            chainId: BSC_CHAIN_ID_HEX,
            chainName: "BNB Smart Chain",
            nativeCurrency: { name:"BNB", symbol:"BNB", decimals:18 },
            rpcUrls: ["https://bsc-dataseed.binance.org/"],
            blockExplorerUrls: ["https://bscscan.com"]
          }]
        });
        setStatus("BSC agregada ‚úÖ", "ok");
      }catch(e2){ setStatus("No se pudo agregar BSC", "bad"); }
    }else{
      setStatus("No se pudo cambiar de red", "bad");
    }
  }
}

/* ========= Aprobar USDT ========= */
async function approveUSDT(){
  try{
    if(!signer) return setStatus("Conecta tu wallet primero", "bad");
    // Validaciones de monto
    const v = parseFloat(amountInput.value || "0");
    if(!isFinite(v) || v <= 0) return setStatus("Ingresa un monto v√°lido", "bad");
    if(v < MIN_USDT) return setStatus(`M√≠nimo: ${MIN_USDT} USDT`, "bad");
    if(v > MAX_USDT) return setStatus(`M√°ximo: ${MAX_USDT} USDT por wallet`, "bad");

    const amountWei = ethers.utils.parseUnits(v.toString(), 18); // USDT BSC = 18 dec
    const tx = await usdtWrite.approve(PRESALE, amountWei);
    setStatus("Aprobando USDT‚Ä¶ ‚è≥");
    await tx.wait();
    setStatus("USDT aprobado ‚úÖ", "ok");
  }catch(err){
    console.error(err);
    setStatus("Error en approve()", "bad");
  }
}

/* ========= Comprar ========= */
async function buyBNC(){
  try{
    if(!signer) return setStatus("Conecta tu wallet primero", "bad");
    const v = parseFloat(amountInput.value || "0");
    if(!isFinite(v) || v <= 0) return setStatus("Ingresa un monto v√°lido", "bad");
    if(v < MIN_USDT) return setStatus(`M√≠nimo: ${MIN_USDT} USDT`, "bad");
    if(v > MAX_USDT) return setStatus(`M√°ximo: ${MAX_USDT} USDT por wallet`, "bad");

    const amountWei = ethers.utils.parseUnits(v.toString(), 18);
    // (Opcional) verificar allowance antes de comprar
    const owner = await signer.getAddress();
    const alw = await usdtRead.allowance(owner, PRESALE);
    if(alw.lt(amountWei)) return setStatus("Primero haz Approve del monto indicado", "bad");

    const tx = await presaleWrite.buyWithUSDT(amountWei);
    setStatus("Comprando‚Ä¶ ‚è≥");
    await tx.wait();
    setStatus("Compra exitosa üéâ ¬°Revisa tu BNC en la wallet!", "ok");
  }catch(err){
    console.error(err);
    setStatus("Error al comprar", "bad");
  }
}

/* ========= Hooks de UI ========= */
$("btnConnect").onclick = connectAnyWallet;
$("btnSwitch").onclick  = switchToBSC;
$("btnApprove").onclick = approveUSDT;
$("btnBuy").onclick     = buyBNC;
</script>
</body>
</html>
